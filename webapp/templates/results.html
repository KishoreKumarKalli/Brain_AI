{% extends "layout.html" %}

{% block title %}Processing Results{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-primary text-white">
            <h2 class="my-0"><i class="fas fa-brain"></i> Brain Scan Analysis Results</h2>
        </div>
        <div class="card-body">
            <div class="alert alert-info">
                <h4>Scan Information</h4>
                <p><strong>Original Filename:</strong> {{ scan_info.original_name }}</p>
                <p><strong>Processed On:</strong> {{ scan_info.upload_time }}</p>
                <p><strong>Report Generated:</strong> {{ timestamp }}</p>
                <a href="{{ url_for('download_file', filename=scan_info.filename) }}" class="btn btn-sm btn-outline-secondary">
                    <i class="fas fa-download"></i> Download Original Scan
                </a>
            </div>

            <hr>

            <div class="row">
                <!-- Segmentation Results -->
                {% if results.segmentation %}
                <div class="col-md-6 mb-4">
                    <div class="card h-100 shadow-sm">
                        <div class="card-header bg-success text-white">
                            <h4 class="my-0">Brain Segmentation</h4>
                        </div>
                        <div class="card-body text-center">
                            <img src="{{ url_for('static', filename='uploads/results/' + results.segmentation.visualization) }}"
                                 alt="Segmentation Visualization"
                                 class="img-fluid mb-3 result-image">
                            <div class="text-left">
                                <div class="mb-3">
                                    <h5>Region Legend:</h5>
                                    <div class="d-flex flex-wrap">
                                        <span class="badge bg-danger m-1">White Matter</span>
                                        <span class="badge bg-primary m-1">Gray Matter</span>
                                        <span class="badge bg-info m-1">CSF</span>
                                        <span class="badge bg-warning m-1">Ventricles</span>
                                        <span class="badge bg-success m-1">Hippocampus</span>
                                    </div>
                                </div>
                            </div>
                            <div class="btn-group mt-2">
                                <a href="{{ url_for('download_file', filename='results/' + results.segmentation.file) }}"
                                   class="btn btn-outline-secondary">
                                    <i class="fas fa-download"></i> Download Segmentation
                                </a>
                                <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#segmentationModal">
                                    <i class="fas fa-search-plus"></i> View Larger
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Volume Chart -->
                {% if results.volume_chart %}
                <div class="col-md-6 mb-4">
                    <div class="card h-100 shadow-sm">
                        <div class="card-header bg-info text-white">
                            <h4 class="my-0">Brain Region Volumes</h4>
                        </div>
                        <div class="card-body text-center">
                            <img src="{{ url_for('static', filename='uploads/results/' + results.volume_chart) }}"
                                 alt="Volume Chart"
                                 class="img-fluid mb-3 result-image">
                            <p class="text-muted">Volumes are measured in cubic millimeters (mmÂ³)</p>
                            <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#volumeChartModal">
                                <i class="fas fa-search-plus"></i> View Larger
                            </button>
                        </div>
                    </div>
                </div>
                {% endif %}
                {% endif %}

                <!-- Anomaly Detection Results -->
                {% if results.anomaly %}
                <div class="col-md-6 mb-4">
                    <div class="card h-100 shadow-sm">
                        <div class="card-header bg-warning text-white">
                            <h4 class="my-0">Anomaly Detection</h4>
                        </div>
                        <div class="card-body text-center">
                            <img src="{{ url_for('static', filename='uploads/results/' + results.anomaly.visualization) }}"
                                 alt="Anomaly Visualization"
                                 class="img-fluid mb-3 result-image">

                            <div class="alert {% if results.anomaly.score > 0.7 %}alert-danger{% elif results.anomaly.score > 0.4 %}alert-warning{% else %}alert-success{% endif %}">
                                <h5>Anomaly Score: {{ "%.2f"|format(results.anomaly.score) }}</h5>
                                <div class="progress">
                                    <div class="progress-bar
                                                {% if results.anomaly.score > 0.7 %}bg-danger
                                                {% elif results.anomaly.score > 0.4 %}bg-warning
                                                {% else %}bg-success{% endif %}"
                                         role="progressbar"
                                         style="width: {{ (results.anomaly.score * 100)|int }}%"
                                         aria-valuenow="{{ (results.anomaly.score * 100)|int }}"
                                         aria-valuemin="0"
                                         aria-valuemax="100"></div>
                                </div>
                                <p class="mt-2 mb-0">
                                    {% if results.anomaly.score > 0.7 %}
                                        <strong>High likelihood of abnormality detected.</strong> Further clinical evaluation recommended.
                                    {% elif results.anomaly.score > 0.4 %}
                                        <strong>Moderate anomaly detected.</strong> Areas of potential concern highlighted.
                                    {% else %}
                                        <strong>Low anomaly score.</strong> No significant abnormalities detected.
                                    {% endif %}
                                </p>
                            </div>

                            <div class="btn-group mt-2">
                                <a href="{{ url_for('download_file', filename='results/' + results.anomaly.file) }}"
                                   class="btn btn-outline-secondary">
                                    <i class="fas fa-download"></i> Download Anomaly Map
                                </a>
                                <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#anomalyModal">
                                    <i class="fas fa-search-plus"></i> View Larger
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- 3D Rendering -->
                {% if results.render_3d %}
                <div class="col-md-12 mb-4">
                    <div class="card shadow-sm">
                        <div class="card-header bg-dark text-white">
                            <h4 class="my-0">3D Brain Rendering</h4>
                        </div>
                        <div class="card-body">
                            <div class="embed-responsive embed-responsive-16by9">
                                <iframe class="embed-responsive-item" src="{{ url_for('static', filename='uploads/results/' + results.render_3d) }}"
                                        height="600px" width="100%" allow="fullscreen"></iframe>
                            </div>
                            <div class="text-center mt-3">
                                <a href="{{ url_for('static', filename='uploads/results/' + results.render_3d) }}"
                                   class="btn btn-outline-primary" target="_blank">
                                    <i class="fas fa-external-link-alt"></i> Open in New Window
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>

            <hr>

            <div class="d-flex justify-content-between mt-4">
                <a href="{{ url_for('upload_file') }}" class="btn btn-primary">
                    <i class="fas fa-upload"></i> Process Another Scan
                </a>
                <a href="{{ url_for('statistical_analysis') }}" class="btn btn-info">
                    <i class="fas fa-chart-bar"></i> Statistical Analysis
                </a>
                <button onclick="window.print()" class="btn btn-secondary">
                    <i class="fas fa-print"></i> Print Results
                </button>
            </div>
        </div>
    </div>

    <!-- Clinical Correlation Section -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-secondary text-white">
            <h3 class="my-0"><i class="fas fa-clipboard-list"></i> Clinical Correlation</h3>
        </div>
        <div class="card-body">
            <div class="alert alert-info">
                <p><i class="fas fa-info-circle"></i> To correlate these imaging findings with clinical data, enter a subject ID below:</p>
            </div>

            <div class="input-group mb-3">
                <input type="text" class="form-control" id="subjectIdInput" placeholder="Enter Subject ID">
                <button class="btn btn-outline-secondary" type="button" id="fetchSubjectDataBtn">
                    <i class="fas fa-search"></i> Fetch Data
                </button>
            </div>

            <div id="clinicalDataResults" class="d-none">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Clinical Data for Subject <span id="displaySubjectId"></span></h5>
                    </div>
                    <div class="card-body">
                        <ul class="nav nav-tabs" id="clinicalDataTabs" role="tablist">
                            <!-- Tab headers will be dynamically generated by JavaScript -->
                        </ul>
                        <div class="tab-content mt-3" id="clinicalDataTabContent">
                            <!-- Tab content will be dynamically generated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>

            <div id="noDataMessage" class="alert alert-warning d-none">
                No clinical data found for this subject ID.
            </div>

            <div id="loadingSpinner" class="text-center d-none">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p>Loading clinical data...</p>
            </div>
        </div>
    </div>
</div>

<!-- Modals for larger image viewing -->
<!-- Segmentation Modal -->
{% if results.segmentation %}
<div class="modal fade" id="segmentationModal" tabindex="-1" aria-labelledby="segmentationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="segmentationModalLabel">Brain Segmentation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <img src="{{ url_for('static', filename='uploads/results/' + results.segmentation.visualization) }}"
                     alt="Segmentation Visualization"
                     class="img-fluid">
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Volume Chart Modal -->
{% if results.volume_chart %}
<div class="modal fade" id="volumeChartModal" tabindex="-1" aria-labelledby="volumeChartModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="volumeChartModalLabel">Brain Region Volumes</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <img src="{{ url_for('static', filename='uploads/results/' + results.volume_chart) }}"
                     alt="Volume Chart"
                     class="img-fluid">
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Anomaly Modal -->
{% if results.anomaly %}
<div class="modal fade" id="anomalyModal" tabindex="-1" aria-labelledby="anomalyModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="anomalyModalLabel">Anomaly Detection</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <img src="{{ url_for('static', filename='uploads/results/' + results.anomaly.visualization) }}"
                     alt="Anomaly Visualization"
                     class="img-fluid">
            </div>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function() {
        // Subject data fetch functionality
        $('#fetchSubjectDataBtn').click(function() {
            const subjectId = $('#subjectIdInput').val().trim();
            if (!subjectId) {
                alert('Please enter a subject ID');
                return;
            }

            // Show loading spinner
            $('#loadingSpinner').removeClass('d-none');
            $('#clinicalDataResults').addClass('d-none');
            $('#noDataMessage').addClass('d-none');

            // Fetch subject data
            $.ajax({
                url: '/api/subject_data/' + encodeURIComponent(subjectId),
                method: 'GET',
                success: function(response) {
                    $('#loadingSpinner').addClass('d-none');

                    if (response.error || Object.keys(response.data).length === 0) {
                        $('#noDataMessage').removeClass('d-none');
                        return;
                    }

                    // Display the data
                    displaySubjectData(response.data, subjectId);
                },
                error: function(error) {
                    $('#loadingSpinner').addClass('d-none');
                    $('#noDataMessage').removeClass('d-none');
                    console.error('Error fetching subject data:', error);
                }
            });
        });

        function displaySubjectData(data, subjectId) {
            // Set subject ID
            $('#displaySubjectId').text(subjectId);

            // Clear existing tabs and content
            $('#clinicalDataTabs').empty();
            $('#clinicalDataTabContent').empty();

            // Generate tabs and content for each data source
            let isFirst = true;

            Object.keys(data).forEach(function(key, index) {
                // Skip if no data
                if (!data[key] || data[key].length === 0) return;

                // Create tab
                const tabId = 'tab-' + key.toLowerCase().replace('_', '-');
                const tabActive = isFirst ? 'active' : '';
                const tabButton = `
                    <li class="nav-item" role="presentation">
                        <button class="nav-link ${tabActive}" id="${tabId}-tab" data-bs-toggle="tab"
                                data-bs-target="#${tabId}" type="button" role="tab"
                                aria-controls="${tabId}" aria-selected="${isFirst ? 'true' : 'false'}">
                            ${key}
                        </button>
                    </li>
                `;
                $('#clinicalDataTabs').append(tabButton);

                // Create tab content with data table
                const tabContentActive = isFirst ? 'show active' : '';
                let tableHtml = '<table class="table table-striped table-sm"><thead><tr>';

                // Table headers
                const firstRow = data[key][0];
                Object.keys(firstRow).forEach(function(colName) {
                    tableHtml += `<th>${colName}</th>`;
                });
                tableHtml += '</tr></thead><tbody>';

                // Table rows
                data[key].forEach(function(row) {
                    tableHtml += '<tr>';
                    Object.values(row).forEach(function(value) {
                        tableHtml += `<td>${value}</td>`;
                    });
                    tableHtml += '</tr>';
                });

                tableHtml += '</tbody></table>';

                const tabContent = `
                    <div class="tab-pane fade ${tabContentActive}" id="${tabId}" role="tabpanel" aria-labelledby="${tabId}-tab">
                        <div class="table-responsive">
                            ${tableHtml}
                        </div>
                    </div>
                `;
                $('#clinicalDataTabContent').append(tabContent);

                isFirst = false;
            });

            // Show the results
            $('#clinicalDataResults').removeClass('d-none');
        }
    });
</script>
{% endblock %}